---
title: "Os2d模型部署"
date: 2021-11-05T14:52:27+08:00
weight: 0500
draft: false
---


首先打包镜像并推送

```
!sh build_and_push.sh os2dv1
```
然后部署一个预置的endpoint



```shell script
#注意修改：015708445809.dkr.ecr.cn-north-1.amazonaws.com.cn/yolov5为自己对应的
%cd endpoint

!python create_endpoint.py \
--endpoint_ecr_image_path "015708445809.dkr.ecr.cn-north-1.amazonaws.com.cn/os2dv1" \
--endpoint_name 'os2dv1' \
--instance_type "ml.p3.2xlarge"
%cd ..
```
输出
```
model_name:  yolov5
endpoint_ecr_image_path:  015708445809.dkr.ecr.cn-north-1.amazonaws.com.cn/os2dv1
<<< Completed model endpoint deployment. os2dv1

```

![](../pics/02pegasus/14.png)

当状态变为`InService`即代表部署完成

在部署结束后，看到SageMaker控制台生成了对应的endpoint,可以使用如下客户端代码测试调用

```python
%%time 

import boto3
import cv2
import time
import cv2
import json
import ast
import numpy as np
body = b""
with open("./data/demo/5.jpg", "rb") as fp:
    body = fp.read()
# body = cv2.imencode(".jpg", frame)[1].tobytes()
runtime = boto3.client("sagemaker-runtime",region_name="cn-north-1")
response = runtime.invoke_endpoint(
    EndpointName='yolov5',
    Body=body,
    ContentType='application/x-image',
)
body = json.loads(response["Body"].read().decode())
print(len(body))
print(body)
```

结果如下
结果如下
```
89
['37 0.100667 0.559 0.0613333 0.119', '31 0.704333 0.37375 0.0566667 0.1375', '39 0.261333 0.21925 0.06 0.1285', '27 0.431667 0.715 0.054 0.13', '6 0.081 0.076 0.062 0.09', '27 0.486333 0.7145 0.054 0.132', '26 0.433 0.5485 0.0566667 0.135', '20 0.486667 0.91 0.056 0.146', '40 0.249333 0.07125 0.048 0.0955', '31 0.646 0.37475 0.056 0.1365', '22 0.211667 0.91325 0.062 0.1465', '17 0.075 0.38875 0.0633333 0.1185', '17 0.137667 0.38775 0.0606667 0.1165', '40 0.297667 0.071 0.0473333 0.095', '26 0.489333 0.54825 0.056 0.1345', '7 0.164667 0.7225 0.0586667 0.126', '10 0.675 0.06625 0.0446667 0.0945', '1 0.540333 0.71475 0.054 0.1315', '18 0.605667 0.21225 0.0566667 0.1385', '5 0.649667 0.90925 0.0566667 0.1475', '36 0.151667 0.90975 0.0566667 0.1545', '42 0.486667 0.068 0.0466667 0.097', '25 0.600333 0.5485 0.0553333 0.131', '16 0.392333 0.07025 0.046 0.0935', '7 0.104667 0.723 0.06 0.124', '25 0.544333 0.54875 0.0553333 0.1325', '5 0.706333 0.908 0.058 0.148', '11 0.364333 0.381 0.0566667 0.128', '16 0.345 0.07125 0.046 0.0945', '1 0.595333 0.714 0.052 0.132', '4 0.140333 0.075 0.0566667 0.09', '42 0.438667 0.069 0.0466667 0.095', '10 0.628667 0.06675 0.0453333 0.0965', '18 0.589333 0.3775 0.0546667 0.128', '18 0.533333 0.3785 0.056 0.128', '43 0.196333 0.3835 0.0553333 0.124', '36 0.0966667 0.9095 0.056 0.155', '15 0.378333 0.5515 0.0553333 0.13', '21 0.762667 0.90775 0.0586667 0.1455', '21 0.820667 0.9075 0.0586667 0.145', '0 0.594 0.90675 0.0533333 0.1525', '33 0.374333 0.21575 0.0553333 0.1365', '18 0.547 0.21275 0.0566667 0.1395', '0 0.541 0.90675 0.0526667 0.1525', '30 0.271333 0.547 0.052 0.143', '4 0.197667 0.0745 0.0553333 0.089', '24 0.819667 0.37225 0.058 0.1335', '20 0.428667 0.90975 0.0573333 0.1485', '15 0.324333 0.5515 0.054 0.13', '30 0.218 0.54725 0.0546667 0.1435', '11 0.309 0.3815 0.0566667 0.128', '37 0.162667 0.55875 0.0626667 0.1185', '34 0.217 0.7175 0.0526667 0.132', '41 0.581333 0.067 0.0466667 0.096', '33 0.316667 0.21625 0.056 0.1365', '28 0.663 0.20875 0.0566667 0.1435', '43 0.254333 0.38375 0.0593333 0.1245', '39 0.201667 0.22025 0.058 0.1265', '38 0.883333 0.54525 0.06 0.1325', '38 0.767 0.5455 0.0553333 0.132', '28 0.721 0.2075 0.058 0.144', '21 0.879 0.90825 0.0606667 0.1475', '41 0.533333 0.06825 0.0466667 0.0945', '34 0.269667 0.71675 0.0526667 0.1315', '38 0.824333 0.54525 0.058 0.1315', '23 0.778333 0.2075 0.058 0.14', '3 0.648667 0.71375 0.0546667 0.1315', '8 0.845667 0.0625 0.100667 0.098', '24 0.878333 0.372 0.062 0.135', '2 0.142 0.2235 0.0613333 0.121', '14 0.421 0.3775 0.054 0.132', '3 0.703 0.71325 0.0553333 0.1315', '13 0.49 0.21275 0.0586667 0.1405', '9 0.747 0.06375 0.098 0.0985', '24 0.762667 0.37325 0.06 0.1365', '2 0.0786667 0.22375 0.0626667 0.1205', '13 0.431 0.21325 0.058 0.1405', '12 0.870667 0.71275 0.0586667 0.1295', '35 0.378 0.715 0.0533333 0.13', '12 0.756667 0.71275 0.056 0.1285', '14 0.478 0.37675 0.056 0.1325', '35 0.323333 0.716 0.0546667 0.131', '35 0.31 0.90625 0.06 0.1555', '12 0.813667 0.7125 0.0566667 0.129', '35 0.369667 0.906 0.058 0.155', '32 0.655333 0.54575 0.0546667 0.1345', '23 0.897333 0.20525 0.06 0.1405', '32 0.711 0.54475 0.0566667 0.1345', '23 0.837667 0.20675 0.0593333 0.1395']

```

